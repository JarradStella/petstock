-- SQL skills test
-- Question 1: [Customers] who purchased from the [ClassCode] of “CACC” in their initial [Sale]

-- Join sales and product data to eventually identify where customers purchases 'CACC' products as part of their initial sale
WITH table_1 AS (
    SELECT *
    FROM 'Sale.csv' AS sale
    INNER JOIN 'Product.csv' AS product
        ON sale.ProductKey = product.ProductKey
    ORDER BY sale.OrderKey ASC
),

purchase_order_rank AS (
    SELECT 
        *,
        RANK() OVER (PARTITION BY CustomerKey ORDER BY ServerDateTime ASC) AS OrderRank -- where rank is 1, it is the initial sale 
    FROM table_1
)

-- list of customers who had a 'CACC' item in their initial sale
SELECT DISTINCT
    CustomerKey
FROM purchase_order_rank
WHERE OrderRank = 1 
    AND ClassCode = 'CACC'
ORDER BY CustomerKey ASC;
